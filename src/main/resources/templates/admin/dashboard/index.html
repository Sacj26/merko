<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{shared/layouts/admin}" lang="es">

<head>
    <title>Panel de Administración</title>
    <link rel="stylesheet" th:href="@{/css/pages/dashboard.css}">
</head>

<body>
    <div layout:fragment="content" class="dashboard-container">
        <div class="admin-header">
            <h1>Panel de Administración</h1>
            <p>Bienvenido, aquí tienes un resumen rápido del sistema.</p>
            <!-- Botón Power BI -->
            <a class="btn btn-primary" th:href="@{/admin/dashboard/powerbi}" title="Abrir Power BI">
                <i class="fas fa-chart-pie"></i> Abrir Power BI
            </a>



            <!-- KPIs Esenciales -->
            <h2 class="dashboard-section-title">Resumen General</h2>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon sales">
                        <i class="fas fa-cash-register"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value"
                            th:text="${totalHoy != null ? '$' + #numbers.formatDecimal(totalHoy, 1, 'COMMA', 0, 'POINT') : '$0'}">
                            $0</div>
                        <div class="kpi-label">Ventas de hoy</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon sales">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value"
                            th:text="${totalMes != null ? '$' + #numbers.formatDecimal(totalMes, 1, 'COMMA', 0, 'POINT') : '$0'}">
                            $0</div>
                        <div class="kpi-label">Ventas del mes</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon products">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value"
                            th:text="${productosActivos != null ? #numbers.formatInteger(productosActivos, 0, 'COMMA') : '0'}">
                            0</div>
                        <div class="kpi-label">Productos activos</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon purchases">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value"
                            th:text="${comprasMes != null ? '$' + #numbers.formatDecimal(comprasMes, 1, 'COMMA', 0, 'POINT') : '$0'}">
                            $0</div>
                        <div class="kpi-label">Compras del mes</div>
                    </div>
                </div>
            </div>

            <!-- Totales Históricos (Valores) -->
            <h2 class="dashboard-section-title">Totales Históricos</h2>
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <div class="kpi-card">
                    <div class="kpi-icon sales">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value"
                            th:text="${totalVentasHistorico != null ? '$' + #numbers.formatDecimal(totalVentasHistorico, 1, 'COMMA', 0, 'POINT') : '$0'}">
                            $0</div>
                        <div class="kpi-label">Total de Ventas</div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                            <span
                                th:text="${totalDetallesVenta != null ? #numbers.formatInteger(totalDetallesVenta, 0, 'COMMA') : '0'}">0</span>
                            items vendidos
                        </div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon purchases">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value"
                            th:text="${totalComprasHistorico != null ? '$' + #numbers.formatDecimal(totalComprasHistorico, 1, 'COMMA', 0, 'POINT') : '$0'}">
                            $0</div>
                        <div class="kpi-label">Total de Compras</div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                            <span
                                th:text="${totalDetallesCompra != null ? #numbers.formatInteger(totalDetallesCompra, 0, 'COMMA') : '0'}">0</span>
                            items comprados
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficas -->
            <h2 class="dashboard-section-title">Actividad</h2>
            <div class="charts-grid">
                <div class="chart-card">
                    <h4>Ventas de los últimos 30 días</h4>
                    <canvas id="ventasDiariasChart"></canvas>
                    <p id="ventasEmpty" class="no-data" style="display:none">No hay ventas registradas en los últimos 30
                        días.</p>
                </div>

                <div class="chart-card">
                    <h4>Compras de los últimos 30 días</h4>
                    <canvas id="comprasDiariasChart"></canvas>
                    <p id="comprasEmpty" class="no-data" style="display:none">No hay compras registradas en los últimos
                        30 días.</p>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h4>Top 5 productos vendidos (30 días)</h4>
                    <canvas id="topProductosChart"></canvas>
                    <p id="topVentasEmpty" class="no-data" style="display:none">No hay productos vendidos en este
                        periodo.</p>
                </div>

                <div class="chart-card">
                    <h4>Top 5 productos comprados (30 días)</h4>
                    <canvas id="topProductosComprasChart"></canvas>
                    <p id="topComprasEmpty" class="no-data" style="display:none">No hay productos comprados en este
                        periodo.</p>
                </div>
            </div>

            <!-- Alertas -->
            <h2 class="dashboard-section-title">Alertas de Inventario</h2>
            <div class="alert-grid">
                <!-- Stock Crítico -->
                <div class="alert-card">
                    <h3><i class="fas fa-exclamation-triangle"></i> Stock Crítico</h3>
                    <div th:if="${stockCritico != null and !#lists.isEmpty(stockCritico)}">
                        <table class="alert-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Stock</th>
                                    <th>Mínimo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${stockCritico}">
                                    <td th:text="${item.nombre}">Producto</td>
                                    <td class="stock-warning" th:text="${item.stock}">0</td>
                                    <td th:text="${item.stockMinimo}">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div th:if="${stockCritico == null or #lists.isEmpty(stockCritico)}" class="no-data">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: #27ae60;"></i>
                        <p>No hay productos con stock crítico</p>
                    </div>
                </div>

                <!-- Próximos Vencimientos -->
                <div class="alert-card">
                    <h3><i class="fas fa-calendar-times"></i> Próximos Vencimientos (30 días)</h3>
                    <div th:if="${proximosVencimientos != null and !#lists.isEmpty(proximosVencimientos)}">
                        <table class="alert-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Lote</th>
                                    <th>Vence</th>
                                    <th>Cant.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${proximosVencimientos}">
                                    <td th:text="${item.lote.producto != null ? item.lote.producto.nombre : '—'}">
                                        Producto</td>
                                    <td th:text="${item.lote.codigoLote}">Lote</td>
                                    <td th:text="${#temporals.format(item.lote.fechaVencimiento, 'dd/MM/yyyy')}">
                                        01/01/2025</td>
                                    <td th:text="${item.lote.cantidadDisponible}">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div th:if="${proximosVencimientos == null or #lists.isEmpty(proximosVencimientos)}"
                        class="no-data">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: #27ae60;"></i>
                        <p>No hay lotes próximos a vencer</p>
                    </div>
                </div>
            </div>

            <!-- Últimas Ventas -->
            <h2 class="dashboard-section-title">Últimas Ventas</h2>
            <div class="alert-card">
                <div th:if="${ultimasVentas != null and !#lists.isEmpty(ultimasVentas)}">
                    <table class="alert-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="venta : ${ultimasVentas}">
                                <td th:text="${venta.usuario != null ? venta.usuario.nombre : '—'}">Cliente</td>
                                <td th:text="${#temporals.format(venta.fecha, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:30
                                </td>
                                <td th:text="'$' + ${#numbers.formatDecimal(venta.total, 1, 'COMMA', 0, 'POINT')}">$0
                                </td>
                                <td>
                                    <span th:if="${venta.estado == T(merko.merko.Entity.EstadoVenta).ACTIVA}"
                                        class="badge badge-success">Activa</span>
                                    <span th:if="${venta.estado == T(merko.merko.Entity.EstadoVenta).ANULADA}"
                                        class="badge badge-danger">Anulada</span>
                                    <span th:if="${venta.estado == null}" class="badge badge-secondary">—</span>
                                </td>
                                <td>
                                    <a th:href="@{/admin/ventas/{id}(id=${venta.id})}"
                                        style="color: #3498db; text-decoration: none;">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${ultimasVentas == null or #lists.isEmpty(ultimasVentas)}" class="no-data">
                    No hay ventas registradas recientemente
                </div>
            </div>
        </div>

        <th:block layout:fragment="scripts">
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script th:src="@{/js/pages/admin/dashboard/index.js}"></script>
        </th:block>
</body>

</html>