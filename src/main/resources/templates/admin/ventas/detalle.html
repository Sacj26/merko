<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{shared/layouts/admin}"
      lang="es">
<head>
    <title>Detalle de Venta</title>
    <!-- Reuse compras detalle CSS for a similar layout; adjust style file if you prefer a ventas-specific CSS -->
    <link rel="stylesheet" th:href="@{/css/modules/compras-detalle.css}">
    <link rel="stylesheet" th:href="@{/css/pages/ventas-detalle.css}">
</head>
<body>
<div layout:fragment="content">
    <div class="header-with-actions">
        <h1 class="page-title">Detalle de Venta
            <small style="margin-left: .5rem;">
                <span th:if="${venta.estado == T(merko.merko.Entity.EstadoVenta).ACTIVA}" class="badge bg-success">ACTIVA</span>
                <span th:if="${venta.estado == T(merko.merko.Entity.EstadoVenta).ANULADA}" class="badge bg-secondary">ANULADA</span>
            </small>
        </h1>
        <a th:href="@{/admin/ventas}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    <div class="detail-container">
        <div class="detail-section">
            <h2>Información General</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <strong>ID</strong>
                    <span th:text="${venta.id}">1</span>
                </div>
                <div class="detail-item">
                    <strong>Fecha y Hora</strong>
                    <span th:text="${venta.fecha != null ? #temporals.format(venta.fecha, 'dd/MM/yyyy HH:mm') : '—'}">01/01/2025 10:00</span>
                </div>
                <div class="detail-item">
                    <strong>Cliente</strong>
                    <span th:text="${venta.cliente != null ? venta.cliente.nombre : 'No registrado'}">Cliente</span>
                </div>
                <div class="detail-item">
                    <strong>Proveedor</strong>
                    <span th:text="${venta.branch != null and venta.branch.proveedor != null ? venta.branch.proveedor.nombre : '—'}">Proveedor</span>
                </div>
                <div class="detail-item">
                    <strong>Sucursal</strong>
                    <span th:text="${venta.branch != null ? (venta.branch.nombre + (venta.branch.ciudad != null ? ' — ' + venta.branch.ciudad : '') + (venta.branch.pais != null ? ', ' + venta.branch.pais : '')) : '—'}">Sucursal</span>
                </div>
                <div class="detail-item">
                    <strong>Total</strong>
                    <span th:text="${'$' + #numbers.formatDecimal(venta.total, 1, 'COMMA', 2, 'POINT')}">$0.00</span>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <h2>Productos Vendidos 
                <span th:if="${venta.detalles != null}" style="font-size: 0.85rem; color: #666; font-weight: normal;">
                    (<span th:text="${#lists.size(venta.detalles)}">0</span> ítems)
                </span>
            </h2>

            <!-- Mostrar tabla de detalles si existen -->
            <div th:if="${venta.detalles != null and !#lists.isEmpty(venta.detalles)}">
                <table class="table-admin">
                    <thead>
                        <tr>
                            <th style="width: 45%;">Producto</th>
                            <th style="width: 15%; text-align: center;">Cantidad</th>
                            <th style="width: 20%; text-align: right;">Precio Unitario</th>
                            <th style="width: 20%; text-align: right;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="det : ${venta.detalles}">
                            <td>
                                <span th:if="${det.producto != null}" th:text="${det.producto.nombre}">Producto</span>
                                <span th:if="${det.producto == null}" style="color: #999; font-style: italic;">
                                    Producto no encontrado (ID del detalle: <span th:text="${det.id}">-</span>)
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <strong th:text="${#numbers.formatInteger(det.cantidad, 1, 'COMMA')}">1</strong> unidades
                            </td>
                            <td style="text-align: right;">
                                <span th:text="${'$' + #numbers.formatDecimal(
                                    det.precioUnitario != null ? det.precioUnitario : 0, 
                                    1, 'COMMA', 2, 'POINT')}">$0.00</span>
                            </td>
                            <td style="text-align: right;">
                                <strong th:text="${'$' + #numbers.formatDecimal(
                                    (det.cantidad != null and det.precioUnitario != null ? det.cantidad * det.precioUnitario : 0), 
                                    1, 'COMMA', 2, 'POINT')}">$0.00</strong>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <!-- Calcular suma real de los subtotales -->
                        <tr th:with="sumaCalculada=${#aggregates.sum(venta.detalles.![cantidad != null and precioUnitario != null ? cantidad * precioUnitario : 0])}" 
                            style="border-top: 2px solid #ddd;">
                            <td colspan="3" style="text-align:right; padding: 0.75rem;">Suma de subtotales:</td>
                            <td style="text-align: right; padding: 0.75rem;" 
                                th:text="${'$' + #numbers.formatDecimal(sumaCalculada, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                        </tr>
                        <tr th:with="sumaSubtotales=${#aggregates.sum(venta.detalles.![cantidad != null and precioUnitario != null ? cantidad * precioUnitario : 0])},
                                       diferencia=${T(java.lang.Math).abs(venta.total != null ? venta.total.doubleValue() - sumaSubtotales.doubleValue() : 0)}"
                            th:if="${diferencia > 0.01}"
                            style="background-color: #fff3cd;">
                            <td colspan="3" style="text-align:right; padding: 0.75rem;">
                                <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                                Total registrado en venta:
                            </td>
                            <td style="text-align: right; padding: 0.75rem;" 
                                th:text="${'$' + #numbers.formatDecimal(venta.total, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                        </tr>
                        <tr th:with="sumaSubtotales=${#aggregates.sum(venta.detalles.![cantidad != null and precioUnitario != null ? cantidad * precioUnitario : 0])},
                                       diferencia=${T(java.lang.Math).abs(venta.total != null ? venta.total.doubleValue() - sumaSubtotales.doubleValue() : 0)}"
                            th:if="${diferencia > 0.01}"
                            style="background-color: #fff3cd;">
                            <td colspan="3" style="text-align:right; padding: 0.75rem; font-size: 0.9rem;">
                                Diferencia (puede deberse a redondeos o ajustes):
                            </td>
                            <td style="text-align: right; padding: 0.75rem; font-size: 0.9rem;" 
                                th:text="${'$' + #numbers.formatDecimal(diferencia, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="detail-grid" th:if="${venta.detalles == null || #lists.isEmpty(venta.detalles)}">
                <div class="detail-item">
                    <strong>Producto</strong>
                    <span th:text="${venta.producto != null ? venta.producto.nombre : '—'}"></span>
                </div>
                <div class="detail-item">
                    <strong>Cantidad</strong>
                    <span th:text="${(venta.cantidad != null ? venta.cantidad : 0) + ' unidades'}"></span>
                </div>
                <div class="detail-item">
                    <strong>Precio Unitario</strong>
                    <span th:text="${'$' + #numbers.formatDecimal(venta.precioUnidad != null ? venta.precioUnidad : 0, 1, 'COMMA', 2, 'POINT')}"></span>
                </div>
                <div class="detail-item">
                    <strong>Total</strong>
                    <span th:text="${'$' + #numbers.formatDecimal(venta.total, 1, 'COMMA', 2, 'POINT')}"></span>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <h2>Movimientos de inventario</h2>
            <div th:if="${movimientos != null && !#lists.isEmpty(movimientos)}">
                <table class="table-admin">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Producto</th>
                            <th>Lote</th>
                            <th>Cantidad</th>
                            <th>Costo unitario</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="m : ${movimientos}">
                            <td th:text="${#temporals.format(m.fecha, 'dd/MM/yyyy HH:mm')}">01/01/2025 10:00</td>
                            <td th:text="${m.tipo}">VENTA_SALIDA</td>
                            <td th:text="${m.producto != null ? m.producto.nombre : '—'}">Producto</td>
                            <td th:text="${m.lote != null ? m.lote.codigoLote : '—'}">LOTE</td>
                            <td th:text="${m.cantidad}">0</td>
                            <td th:text="${m.costoUnitario != null ? #numbers.formatDecimal(m.costoUnitario, 1, 'COMMA', 2, 'POINT') : '—'}">0.00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div th:if="${movimientos == null or #lists.isEmpty(movimientos)}">
                <p>No hay movimientos registrados para esta venta.</p>
            </div>
        </div>

        <div class="btn-container">
            <a th:href="@{/admin/ventas}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al listado
            </a>

            <div style="display:inline-block; margin-left:.5rem;" th:if="${venta.estado == T(merko.merko.Entity.EstadoVenta).ACTIVA}">
                <form th:action="@{'/admin/ventas/' + ${venta.id} + '/reversar'}" method="post" onsubmit="return confirm('¿Seguro que deseas anular esta venta y revertir el inventario?');" style="display:inline-block;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-undo"></i> Anular venta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>
