<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{shared/layouts/admin}"
      lang="es">
<head>
    <title>Nueva Compra</title>
    <link rel="stylesheet" th:href="@{/css/components/forms.css}">
    <link rel="stylesheet" th:href="@{/css/components/buttons.css}">
    <link rel="stylesheet" th:href="@{/css/modules/compras.css}">
</head>
<body>
    <div layout:fragment="content">
        <div class="header-with-actions">
            <div class="title-group">
                <h1 class="page-title">Registrar Nueva Compra</h1>
                <p class="page-subtitle">Ingresa los datos de la compra al proveedor</p>
            </div>
        </div>

        <div class="form-container">
            <form th:action="@{/admin/compras/guardar}" method="post" id="compraForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                
                <!-- Info alert about automatic lot creation -->
                <div class="alert alert-info" style="margin-bottom: 1.5rem; padding: 1rem; background-color: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px;">
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <i class="fas fa-info-circle" style="color: #0066cc; margin-top: 0.25rem;"></i>
                        <div style="flex: 1;">
                            <strong>Gestión automática de lotes</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                Los productos se agregarán al inventario y se crearán lotes automáticamente con la información de esta compra.
                                Se pueden comprar <strong>productos activos</strong> del proveedor seleccionado. Si un producto gestiona lotes, se generarán; si requiere vencimiento, se calculará con su vida útil.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="proveedor">Proveedor</label>
                    <div class="form-row">
                        <div class="field-cell">
                            <select id="proveedor" name="proveedorId" class="form-control" required>
                                <option value="">Seleccione un proveedor</option>
                                <option th:each="proveedor : ${proveedores}"
                                        th:value="${proveedor.id}"
                                        th:text="${proveedor.nombre}"></option>
                            </select>
                        </div>
                        <div class="actions-cell">
                            <button type="button" id="btnAgregarProductoProveedor" class="btn-icon btn-icon-secondary" disabled
                                    title="Agregar producto a este proveedor" aria-label="Agregar producto a proveedor" onclick="irAAgregarProductos()">
                                <i class="fas fa-boxes"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ítems de la compra <span class="text-muted" style="font-weight: normal;">(productos activos del proveedor)</span></label>
                    <div class="table-container" style="margin-top:.5rem;">
                        <table class="table-admin" id="tablaItems">
                            <thead>
                                <tr>
                                    <th style="min-width:260px;">Producto</th>
                                    <th style="width:120px;">Cantidad</th>
                                    <th style="width:160px;" title="Precio de Compra">P. Compra</th>
                                    <th style="width:160px;">Total</th>
                                    <th class="actions-col">
                                        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
                                            <span>Acciones</span>
                                            <button type="button" class="btn-icon btn-icon-primary" id="btnAgregarItem" title="Agregar ítem" aria-label="Agregar ítem">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody">
                                <!-- Filas dinámicas -->
                            </tbody>
                        </table>
                    </div>
                    
                </div>

                <div class="producto-info" id="resumenCompra" style="display:flex; justify-content: space-between; align-items:center; flex-wrap:wrap; gap:.75rem;">
                    <div>
                        <p style="margin:0;">Total de la compra: <strong id="totalCompra">$0.00</strong></p>
                    </div>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar compra
                    </button>
                    <a th:href="@{/admin/compras}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script th:src="@{/js/pages/compras/crear.js}"></script>
    </th:block>
</body>
</html>