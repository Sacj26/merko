<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{shared/layouts/admin}"
      lang="es">
<head>
    <title th:text="${titulo}">Formulario Producto</title>
    <link rel="stylesheet" th:href="@{/css/components/forms.css}" />
    <link rel="stylesheet" th:href="@{/css/components/buttons.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<div layout:fragment="content">
    <div class="header-with-actions">
        <div class="title-group">
            <h1 class="page-title" th:text="${titulo}">Formulario Producto</h1>
            <p class="page-subtitle">Complete la información del producto</p>
        </div>
        <div class="actions">
            <a th:href="@{/admin/productos}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="form-container">
        <form th:action="@{${accion}}" th:object="${producto}" method="post" enctype="multipart/form-data" class="form-admin">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" th:field="*{id}" />
            <input type="hidden" name="branchId" th:value="${selectedBranchId}" />

            <div class="form-sections-modern">
                <!-- Sección: Información Básica -->
                <fieldset class="form-section form-section-modern">
                    <legend class="form-section-legend">
                        <i class="fas fa-box"></i> Información Básica del Producto
                    </legend>
                    
                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label for="nombre" class="form-label-modern">
                                <i class="fas fa-tag text-primary"></i> Nombre del Producto
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="nombre" th:field="*{nombre}" class="form-control form-control-modern" 
                                   placeholder="Ej: Leche Entera 1L" required maxlength="150" />
                            <small class="form-help">Nombre comercial del producto</small>
                        </div>

                        <div class="form-group">
                            <label for="sku" class="form-label-modern">
                                <i class="fas fa-barcode text-primary"></i> SKU
                            </label>
                            <input type="text" id="sku" th:field="*{sku}" class="form-control form-control-modern" 
                                   placeholder="Ej: PROD-001" maxlength="50" />
                            <small class="form-help">Código interno único del producto</small>
                        </div>

                        <div class="form-group">
                            <label for="codigoBarras" class="form-label-modern">
                                <i class="fas fa-qrcode text-primary"></i> Código de Barras
                            </label>
                            <input type="text" id="codigoBarras" th:field="*{codigoBarras}" class="form-control form-control-modern" 
                                   placeholder="Ej: 7701234567890" maxlength="50" />
                            <small class="form-help">EAN-13, UPC u otro código estándar</small>
                        </div>

                        <div class="form-group">
                            <label for="marca" class="form-label-modern">
                                <i class="fas fa-copyright text-primary"></i> Marca
                            </label>
                            <input type="text" id="marca" th:field="*{marca}" class="form-control form-control-modern" 
                                   placeholder="Ej: Alpina" maxlength="100" />
                            <small class="form-help">Marca comercial del producto</small>
                        </div>

                        <div class="form-group">
                            <label for="categoria" class="form-label-modern">
                                <i class="fas fa-folder text-primary"></i> Categoría
                            </label>
                            <select id="categoria" name="categoriaId" class="form-control form-control-modern">
                                <option value="">-- Seleccionar categoría --</option>
                                <option th:each="c : ${categorias}" th:value="${c.id}"
                                        th:selected="${producto.categoria != null and producto.categoria.id == c.id}"
                                        th:text="${c.nombre}"></option>
                            </select>
                            <small class="form-help">Clasificación del producto</small>
                        </div>

                        <div class="form-group">
                            <label for="tipo" class="form-label-modern">
                                <i class="fas fa-shapes text-primary"></i> Tipo de Producto
                            </label>
                            <input type="text" id="tipo" th:field="*{tipo}" class="form-control form-control-modern" 
                                   placeholder="Ej: Simple, Compuesto" maxlength="50" />
                            <small class="form-help">Simple, Compuesto, Servicio, Materia Prima</small>
                        </div>

                        <div class="form-group">
                            <label for="estado" class="form-label-modern">
                                <i class="fas fa-toggle-on text-primary"></i> Estado
                            </label>
                            <input type="text" id="estado" th:field="*{estado}" class="form-control form-control-modern" 
                                   placeholder="Ej: Activo" maxlength="50" />
                            <small class="form-help">Activo, Descontinuado, En Revisión</small>
                        </div>

                        <div class="form-group form-group-full">
                            <label for="descripcion" class="form-label-modern">
                                <i class="fas fa-align-left text-primary"></i> Descripción
                                <span class="required">*</span>
                            </label>
                            <textarea id="descripcion" th:field="*{descripcion}" class="form-control form-control-modern" 
                                      rows="3" placeholder="Descripción detallada del producto" required maxlength="500"></textarea>
                            <small class="form-help">Información detallada sobre el producto</small>
                        </div>
                    </div>
                </fieldset>

                <!-- Sección: Presentación y Unidades -->
                <fieldset class="form-section form-section-modern">
                    <legend class="form-section-legend">
                        <i class="fas fa-box-open"></i> Presentación y Unidades de Medida
                    </legend>
                    
                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label for="unidadMedida" class="form-label-modern">
                                <i class="fas fa-ruler text-success"></i> Unidad de Medida
                                <span class="required">*</span>
                            </label>
                            <select id="unidadMedida" th:field="*{unidadMedida}" class="form-control form-control-modern" required>
                                <option value="">-- Seleccionar unidad --</option>
                                <option th:each="u : ${T(merko.merko.Entity.UnidadMedida).values()}" 
                                        th:value="${u}" 
                                        th:text="${#strings.capitalize(#strings.replace(u.name(), '_', ' '))}"></option>
                            </select>
                            <small class="form-help">Unidad de medida para ventas e inventario</small>
                        </div>

                        <div class="form-group">
                            <label for="contenidoNeto" class="form-label-modern">
                                <i class="fas fa-flask text-success"></i> Contenido Neto
                            </label>
                            <input type="number" id="contenidoNeto" th:field="*{contenidoNeto}" 
                                   class="form-control form-control-modern" step="0.01" min="0" placeholder="Ej: 500" />
                            <small class="form-help">Cantidad neta del producto</small>
                        </div>

                        <div class="form-group">
                            <label for="contenidoUom" class="form-label-modern">
                                <i class="fas fa-balance-scale text-success"></i> Unidad del Contenido
                            </label>
                            <select id="contenidoUom" th:field="*{contenidoUom}" class="form-control form-control-modern">
                                <option value="">-- Seleccionar unidad --</option>
                                <option th:each="u : ${T(merko.merko.Entity.UnidadMedida).values()}" 
                                        th:value="${u}" 
                                        th:text="${#strings.capitalize(#strings.replace(u.name(), '_', ' '))}"></option>
                            </select>
                            <small class="form-help">Ej: si contenido es 500, puede ser G (gramos) o ML</small>
                        </div>
                    </div>
                </fieldset>

                <!-- Sección: Precios e Inventario -->
                <fieldset class="form-section form-section-modern">
                    <legend class="form-section-legend">
                        <i class="fas fa-dollar-sign"></i> Precios e Inventario
                    </legend>
                    
                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label for="precioCompra" class="form-label-modern">
                                <i class="fas fa-shopping-cart text-info"></i> Precio de Compra
                            </label>
                            <input type="number" id="precioCompra" th:field="*{precioCompra}" 
                                   class="form-control form-control-modern" step="0.01" min="0" placeholder="0.00" />
                            <small class="form-help">Costo unitario del producto</small>
                        </div>

                        <div class="form-group">
                            <label for="precioVenta" class="form-label-modern">
                                <i class="fas fa-tag text-info"></i> Precio de Venta
                                <span class="required">*</span>
                            </label>
                            <input type="number" id="precioVenta" th:field="*{precioVenta}" 
                                   class="form-control form-control-modern" step="0.01" min="0" placeholder="0.00" required />
                            <small class="form-help">Precio al público</small>
                        </div>

                        <div class="form-group">
                            <label for="initialStock" class="form-label-modern">
                                <i class="fas fa-boxes text-info"></i> Stock Inicial
                            </label>
                            <input type="number" id="initialStock" name="initialStock" 
                                   class="form-control form-control-modern" min="0" placeholder="0" />
                            <small class="form-help">Cantidad inicial en inventario</small>
                        </div>

                        <div class="form-group">
                            <label for="stockMinimo" class="form-label-modern">
                                <i class="fas fa-exclamation-triangle text-info"></i> Stock Mínimo
                            </label>
                            <input type="number" id="stockMinimo" th:field="*{stockMinimo}" 
                                   class="form-control form-control-modern" min="0" placeholder="0" />
                            <small class="form-help">Nivel mínimo de existencias</small>
                        </div>

                        <div class="form-group">
                            <label for="puntoReorden" class="form-label-modern">
                                <i class="fas fa-sync-alt text-info"></i> Punto de Reorden
                            </label>
                            <input type="number" id="puntoReorden" th:field="*{puntoReorden}" 
                                   class="form-control form-control-modern" min="0" placeholder="0" />
                            <small class="form-help">Nivel para nueva orden de compra</small>
                        </div>

                        <div class="form-group">
                            <label for="leadTimeDias" class="form-label-modern">
                                <i class="fas fa-clock text-info"></i> Lead Time (días)
                            </label>
                            <input type="number" id="leadTimeDias" th:field="*{leadTimeDias}" 
                                   class="form-control form-control-modern" min="0" placeholder="0" />
                            <small class="form-help">Tiempo de reposición del proveedor</small>
                        </div>
                    </div>
                </fieldset>

                <!-- Sección: Proveedor -->
                <fieldset class="form-section form-section-modern">
                    <legend class="form-section-legend">
                        <i class="fas fa-truck"></i> Información del Proveedor
                    </legend>
                    
                    <div class="form-grid form-grid-2">
                        <!-- If coming from branch: show locked info -->
                        <div th:if="${proveedor != null and branch != null}" class="form-group form-group-full">
                            <div style="padding: 1rem; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-lock" style="color: #3b82f6; font-size: 1.25rem;"></i>
                                    <div>
                                        <strong style="color: #1e40af; display: block;">Proveedor:</strong>
                                        <span th:text="${proveedor.nombre}">Proveedor</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-store" style="color: #3b82f6; font-size: 1.25rem;"></i>
                                    <div>
                                        <strong style="color: #1e40af; display: block;">Sucursal:</strong>
                                        <span th:text="${branch.nombre}">Sucursal</span>
                                    </div>
                                </div>
                                <small style="display: block; margin-top: 0.5rem; color: #1e40af;">
                                    <i class="fas fa-info-circle"></i> El producto se registrará para esta sucursal específica
                                </small>
                            </div>
                            <!-- Hidden fields to submit -->
                            <input type="hidden" name="proveedorId" th:value="${proveedor.id}" />
                        </div>
                        
                        <!-- If NOT from branch: show selector -->
                        <div th:unless="${proveedor != null and branch != null}" class="form-group form-group-full">
                            <label for="proveedorId" class="form-label-modern">
                                <i class="fas fa-building text-warning"></i> Proveedor Principal
                            </label>
                            <select id="proveedorId" name="proveedorId" class="form-control form-control-modern">
                                <option value="">-- Sin proveedor --</option>
                                <option th:each="prov : ${proveedores}" 
                                        th:value="${prov.id}" 
                                        th:text="${prov.nombre}" 
                                        th:selected="${selectedProveedorId != null and selectedProveedorId == prov.id}"></option>
                            </select>
                            <small class="form-help">
                                <i class="fas fa-info-circle"></i> Asigne un proveedor para establecer la relación comercial
                            </small>
                        </div>
                    </div>
                </fieldset>

                <!-- Sección: Lotes y Vencimientos -->
                <fieldset class="form-section form-section-modern">
                    <legend class="form-section-legend">
                        <i class="fas fa-calendar-alt"></i> Control de Lotes y Vencimientos
                    </legend>
                    
                    <div style="margin-bottom: 1.25rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <label class="form-label-modern" style="margin-bottom: 0.5rem;">
                            <i class="fas fa-check-square text-primary"></i> Opciones de Gestión
                        </label>
                        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                <input type="checkbox" th:field="*{gestionaLotes}" style="cursor: pointer;" />
                                <span><i class="fas fa-layer-group"></i> Gestiona lotes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                <input type="checkbox" th:field="*{requiereVencimiento}" style="cursor: pointer;" />
                                <span><i class="fas fa-calendar-times"></i> Requiere vencimiento</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label for="vidaUtilDias" class="form-label-modern">
                                <i class="fas fa-hourglass-half text-primary"></i> Vida Útil (días)
                            </label>
                            <input type="number" id="vidaUtilDias" th:field="*{vidaUtilDias}" 
                                   class="form-control form-control-modern" min="0" placeholder="Ej: 180" />
                            <small class="form-help">Días desde fabricación hasta vencimiento</small>
                        </div>

                        <div class="form-group">
                            <label for="almacenamiento" class="form-label-modern">
                                <i class="fas fa-warehouse text-primary"></i> Almacenamiento
                                <span class="required">*</span>
                            </label>
                            <select id="almacenamiento" th:field="*{almacenamiento}" 
                                    class="form-control form-control-modern" required>
                                <option value="">-- Seleccionar condición --</option>
                                <option th:each="a : ${T(merko.merko.Entity.Almacenamiento).values()}" 
                                        th:value="${a}" 
                                        th:text="${#strings.capitalize(#strings.replace(a.name(), '_', ' '))}"></option>
                            </select>
                            <small class="form-help">Condiciones requeridas de almacenamiento</small>
                        </div>

                        <div class="form-group form-group-full">
                            <label for="registroSanitario" class="form-label-modern">
                                <i class="fas fa-certificate text-primary"></i> Registro Sanitario
                            </label>
                            <input type="text" id="registroSanitario" th:field="*{registroSanitario}" 
                                   class="form-control form-control-modern" placeholder="Ej: INVIMA RSA-0000000-2024" maxlength="100" />
                            <small class="form-help">Número de registro sanitario (INVIMA u otra autoridad)</small>
                        </div>
                    </div>
                </fieldset>

                <!-- Sección: Imagen del Producto -->
                <fieldset class="form-section form-section-modern">
                    <legend class="form-section-legend">
                        <i class="fas fa-image"></i> Imagen del Producto
                    </legend>
                    
                    <div th:if="${producto.id != null && producto.imagenUrl != null}" 
                         style="margin-bottom: 1.25rem; padding: 1rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <label class="form-label-modern" style="margin-bottom: 0.75rem;">
                            <i class="fas fa-eye text-success"></i> Imagen Actual
                        </label>
                        <div style="text-align: center;">
                            <img th:src="@{${producto.imagenUrl}}" alt="Imagen actual" 
                                 style="max-width: 250px; max-height: 250px; border-radius: 8px; border: 2px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="imagen" class="form-label-modern">
                            <i class="fas fa-upload text-primary"></i> Subir Nueva Imagen
                        </label>
                        <input type="file" id="imagen" name="imagen" class="form-control form-control-modern" accept="image/*" />
                        <small class="form-help">
                            <i class="fas fa-info-circle"></i> Formatos soportados: JPG, PNG, GIF (máximo 5 MB)
                        </small>
                    </div>
                </fieldset>
            </div>

            <div class="form-actions" style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1.5rem; border-top: 2px solid #e2e8f0;">
                <a th:href="@{/admin/productos}" class="btn btn-secondary">
                    <i class="fas fa-times-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar Producto
                </button>
            </div>
        </form>
    </div>
</div>
</body>
<th:block layout:fragment="scripts">
    <script th:src="@{/js/pages/productos/form.js}"></script>
</th:block>
</html>
