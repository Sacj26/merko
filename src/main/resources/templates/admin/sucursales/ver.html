<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{shared/layouts/admin}"
      lang="es">
<head>
    <title>Sucursal - Detalle</title>
    <link rel="stylesheet" th:href="@{/css/pages/proveedores.css}">
    <link rel="stylesheet" th:href="@{/css/modules/proveedores.css}">
</head>
<body>
<div layout:fragment="content">
    <div class="header-with-actions">
        <div class="title-group">
            <h1 class="page-title">
                <i class="fas fa-store"></i>
                <span th:text="${branch.nombre}">Sucursal</span>
            </h1>
            <p class="page-subtitle">
                <span th:if="${branch.proveedor != null}">
                    <i class="fas fa-truck"></i>
                    <strong th:text="${branch.proveedor.nombre}">Proveedor</strong>
                </span>
                <span th:if="${branch.ciudad != null or branch.pais != null}">
                    <i class="fas fa-map-marker-alt"></i>
                    <span th:text="${branch.ciudad != null ? branch.ciudad : ''} + ${branch.ciudad != null and branch.pais != null ? ', ' : ''} + ${branch.pais != null ? branch.pais : ''}"></span>
                </span>
            </p>
        </div>
        <div class="actions">
            <a th:if="${branch.proveedor != null}" 
               th:href="@{/admin/proveedores/{provId}/sucursales(provId=${branch.proveedor.id})}" 
               class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 
                <span class="hide-sm">Volver a sucursales</span>
            </a>
            <a th:if="${branch.proveedor != null}" 
               th:href="@{/admin/proveedores/ver/{id}(id=${branch.proveedor.id})}" 
               class="btn btn-secondary hide-sm">
                <i class="fas fa-truck"></i> Ver proveedor
            </a>
            <a th:if="${branch.proveedor != null}"
               th:href="@{/admin/proveedores/{provId}/sucursales/{branchId}/contactos(provId=${branch.proveedor.id},branchId=${branch.id})}" 
               class="btn btn-info">
                <i class="fas fa-address-book"></i> 
                <span class="hide-sm">Contactos</span>
            </a>
            <a th:if="${branch.id != null and branch.proveedor != null}" 
               th:href="@{/admin/proveedores/{provId}/sucursales/editar/{id}(provId=${branch.proveedor.id},id=${branch.id})}" 
               class="btn btn-primary">
                <i class="fas fa-edit"></i> 
                <span class="hide-sm">Editar</span>
            </a>
        </div>
    </div>

    <div class="proveedor-info sucursal-detalle">
        <!-- Información General -->
        <div class="info-section">
            <div class="info-section-header">
                <h3 class="info-section-title">
                    <i class="fas fa-info-circle"></i> Información General
                </h3>
                <div class="info-section-badge">
                    <span th:if="${branch.activo}" class="badge badge-success">
                        <i class="fas fa-check-circle"></i> Activa
                    </span>
                    <span th:unless="${branch.activo}" class="badge badge-secondary">
                        <i class="fas fa-times-circle"></i> Inactiva
                    </span>
                </div>
            </div>
            <div class="info-section-content">
                <div class="info-row">
                    <div class="info-field">
                        <span class="info-label">
                            <i class="fas fa-building"></i> Nombre
                        </span>
                        <span class="info-value" th:text="${branch.nombre ?: '—'}">—</span>
                    </div>
                    <div class="info-field">
                        <span class="info-label">
                            <i class="fas fa-phone"></i> Teléfono
                        </span>
                        <span class="info-value" th:text="${branch.telefono ?: '—'}">—</span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-field info-field-full">
                        <span class="info-label">
                            <i class="fas fa-map-marker-alt"></i> Dirección
                        </span>
                        <span class="info-value" th:text="${branch.direccion ?: '—'}">—</span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-field">
                        <span class="info-label">
                            <i class="fas fa-city"></i> Ciudad
                        </span>
                        <span class="info-value" th:text="${branch.ciudad ?: '—'}">—</span>
                    </div>
                    <div class="info-field">
                        <span class="info-label">
                            <i class="fas fa-globe-americas"></i> País
                        </span>
                        <span class="info-value" th:text="${branch.pais ?: '—'}">—</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contactos -->
        <div class="info-section">
            <div class="info-section-header">
                <h3 class="info-section-title">
                    <i class="fas fa-address-book"></i> Contactos
                </h3>
                <a th:if="${branch.proveedor != null}"
                   th:href="@{/admin/proveedores/{provId}/sucursales/{branchId}/contactos(provId=${branch.proveedor.id},branchId=${branch.id})}" 
                   class="btn btn-sm btn-outline">
                    <i class="fas fa-user-plus"></i> Gestionar contactos
                </a>
            </div>
            <div class="info-section-content">
                <div th:if="${branch.contacts != null and !#lists.isEmpty(branch.contacts)}" class="contacts-grid">
                    <div th:each="c : ${branch.contacts}" class="contact-card" th:classappend="${c.isPrimary ? 'contact-primary' : ''}">
                        <div class="contact-header">
                            <div class="contact-name">
                                <i class="fas fa-user-circle"></i>
                                <strong th:text="${c.nombre}">Nombre</strong>
                            </div>
                            <span th:if="${c.isPrimary}" class="badge badge-primary badge-sm">
                                <i class="fas fa-star"></i> Principal
                            </span>
                        </div>
                        <div class="contact-info">
                            <div th:if="${c.rol != null}" class="contact-detail">
                                <i class="fas fa-briefcase text-muted"></i>
                                <span th:text="${c.rol}">Cargo</span>
                            </div>
                            <div th:if="${c.telefono != null}" class="contact-detail">
                                <i class="fas fa-phone text-muted"></i>
                                <a th:href="'tel:' + ${c.telefono}" th:text="${c.telefono}">Teléfono</a>
                            </div>
                            <div th:if="${c.email != null}" class="contact-detail">
                                <i class="fas fa-envelope text-muted"></i>
                                <a th:href="'mailto:' + ${c.email}" th:text="${c.email}">Email</a>
                            </div>
                            <div th:if="${c.notas != null}" class="contact-notes">
                                <i class="fas fa-sticky-note text-muted"></i>
                                <span th:text="${c.notas}">Notas</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:if="${branch.contacts == null or #lists.isEmpty(branch.contacts)}" class="empty-state-small">
                    <i class="fas fa-user-slash"></i>
                    <p>No hay contactos registrados para esta sucursal</p>
                    <a th:if="${branch.proveedor != null}"
                       th:href="@{/admin/proveedores/{provId}/sucursales/{branchId}/contactos/nuevo(provId=${branch.proveedor.id},branchId=${branch.id})}" 
                       class="btn btn-sm btn-primary">
                        <i class="fas fa-user-plus"></i> Agregar contacto
                    </a>
                </div>
            </div>
        </div>

        <!-- Productos -->
        <div class="info-section">
            <div class="info-section-header">
                <h3 class="info-section-title">
                    <i class="fas fa-boxes"></i> Productos Asignados
                </h3>
                <div class="info-section-actions">
                    <span class="badge badge-info badge-lg" th:if="${productBranches != null}">
                        <i class="fas fa-box"></i>
                        <span th:text="${#lists.size(productBranches)} + ' producto' + (${#lists.size(productBranches)} != 1 ? 's' : '')">0 productos</span>
                    </span>
                    <a th:if="${branch.proveedor != null}" 
                       th:href="@{/admin/productos/nuevo(proveedorId=${branch.proveedor.id},branchId=${branch.id})}" 
                       class="btn btn-sm btn-success hide-sm">
                        <i class="fas fa-plus"></i> Agregar producto
                    </a>
                </div>
            </div>
            <div class="info-section-content">
                <div th:if="${productBranches != null and !#lists.isEmpty(productBranches)}">
                    <div class="table-controls">
                        <div class="table-controls-left">
                            <span class="results-count">
                                <i class="fas fa-list"></i>
                                Mostrando <strong th:text="${#lists.size(productBranches)}">0</strong> productos
                            </span>
                        </div>
                        <div class="table-controls-right">
                            <label for="toggleDenseSucursalProductos" class="hide-sm">
                                <input id="toggleDenseSucursalProductos" type="checkbox" /> Vista compacta
                            </label>
                        </div>
                    </div>

                    <div class="table-container table-scroll">
                        <table class="table-admin" id="tablaProductos">
                            <thead>
                                <tr>
                                    <th class="col-img">Imagen</th>
                                    <th class="col-nombre">Nombre</th>
                                    <th class="col-sku hide-md">SKU</th>
                                    <th class="col-estado hide-sm">Estado</th>
                                    <th class="col-precio">Precio</th>
                                    <th class="col-stock">Stock</th>
                                    <th class="actions-col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="pb : ${productBranches}">
                                    <td class="col-img">
                                        <div class="product-thumb">
                                            <img th:if="${pb.producto.imagenUrl != null}"
                                                 th:src="${pb.producto.imagenUrl}"
                                                 alt="Producto"
                                                 class="product-img">
                                            <div th:unless="${pb.producto.imagenUrl != null}" class="product-img-placeholder">
                                                <i class="fas fa-box"></i>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="col-nombre">
                                        <div class="cell-text-ellipsis">
                                            <div class="cell-title" th:text="${pb.producto.nombre}">Producto</div>
                                            <small class="cell-subtitle" th:if="${pb.producto.sku != null}" th:text="'SKU: ' + ${pb.producto.sku}">SKU</small>
                                        </div>
                                    </td>
                                    <td class="col-sku hide-md">
                                        <code th:if="${pb.producto.sku != null}" th:text="${pb.producto.sku}">SKU</code>
                                        <span th:unless="${pb.producto.sku != null}" class="text-muted">—</span>
                                    </td>
                                    <td class="col-estado hide-sm">
                                        <span th:if="${pb.producto.estado != null and #strings.toLowerCase(pb.producto.estado).contains('activo')}" 
                                              class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> <span th:text="${pb.producto.estado}">Activo</span>
                                        </span>
                                        <span th:unless="${pb.producto.estado != null and #strings.toLowerCase(pb.producto.estado).contains('activo')}" 
                                              th:class="${pb.producto.estado != null ? 'badge badge-warning' : 'badge badge-secondary'}">
                                            <i class="fas fa-exclamation-circle"></i> <span th:text="${pb.producto.estado ?: 'Sin estado'}">—</span>
                                        </span>
                                    </td>
                                    <td class="col-precio">
                                        <strong class="text-success" 
                                                th:text="${pb.precio != null ? ('$' + #numbers.formatDecimal(pb.precio, 1, 'COMMA', 2, 'POINT')) : (pb.producto.precioCompra != null ? ('$' + #numbers.formatDecimal(pb.producto.precioCompra, 1, 'COMMA', 2, 'POINT')) : '—')}">$0.00</strong>
                                    </td>
                                    <td class="col-stock">
                                        <span th:if="${pb.stock != null and pb.stock > 10}" 
                                              class="badge badge-success" 
                                              th:text="${pb.stock}">0</span>
                                        <span th:if="${pb.stock != null and pb.stock > 0 and pb.stock <= 10}" 
                                              class="badge badge-warning" 
                                              th:text="${pb.stock}">0</span>
                                        <span th:if="${pb.stock == null or pb.stock == 0}" 
                                              class="badge badge-danger" 
                                              th:text="${pb.stock != null ? pb.stock : 0}">0</span>
                                    </td>
                                    <td class="actions-col">
                                        <div class="actions-cell">
                                            <a th:href="@{/admin/productos/ver/{id}(id=${pb.producto.id})}" 
                                               class="btn-icon btn-icon-info" 
                                               title="Ver producto">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a th:href="@{/admin/productos/editar/{id}(id=${pb.producto.id})}" 
                                               class="btn-icon btn-icon-primary" 
                                               title="Editar producto">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${productBranches == null or #lists.isEmpty(productBranches)}" class="empty-state-small">
                    <i class="fas fa-box-open"></i>
                    <p>No hay productos asignados a esta sucursal</p>
                    <a th:if="${branch.proveedor != null}" 
                       th:href="@{/admin/productos/nuevo(proveedorId=${branch.proveedor.id},branchId=${branch.id})}" 
                       class="btn btn-primary">
                        <i class="fas fa-plus"></i> Agregar primer producto
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        // Toggle vista compacta
        document.getElementById('toggleDenseSucursalProductos')?.addEventListener('change', function(e) {
            document.getElementById('tablaProductos')?.classList.toggle('table-dense', e.target.checked);
        });
    </script>
</th:block>
</body>
</html>