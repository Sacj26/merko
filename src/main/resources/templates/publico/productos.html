<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Productos - Merko</title>
    <link rel="stylesheet" th:href="@{/css/publico/productos.css}">
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header class="public-header">
    <div class="container header-inner">
        <a th:href="@{/}" class="brand">
            <i class="fas fa-store"></i>
            <span>Merko</span>
        </a>
        <nav class="public-nav">
            <div th:if="${clienteLogueado != null}" class="nav-logged">
                <a th:href="@{/publico/perfil}" class="nav-link">
                    <i class="fas fa-user-circle"></i>
                    <span th:text="${clienteLogueado.nombre}">Perfil</span>
                </a>
                <a th:href="@{/carrito}" class="nav-link cart-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Carrito</span>
                    <span class="cart-badge" id="cartCount" th:text="${cartCount != null ? cartCount : 0}">0</span>
                </a>
                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <button type="submit" class="nav-link" style="background: none; border: none; cursor: pointer; padding: 0; color: inherit;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </form>
            </div>
            <div th:if="${clienteLogueado == null}" class="nav-guest">
                <a th:href="@{/login}" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i>
                    Ingresar
                </a>
                <a th:href="@{/registro}" class="btn-register">Registrarse</a>
            </div>
        </nav>
    </div>
</header>

<main class="main-content">
    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <div class="hero-text">
                    <h1><i class="fas fa-leaf"></i> Alimentos frescos y seleccionados</h1>
                    <p>Descubre productos de calidad premium directamente a tu mesa. Frescura garantizada en cada compra.</p>
                    <div class="hero-stats">
                        <div class="stat-item">
                            <i class="fas fa-box"></i>
                            <div>
                                <strong th:text="${productosPage != null ? productosPage.totalElements : 0}">0</strong>
                                <span>Productos</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-truck"></i>
                            <div>
                                <strong>Env√≠o Gratis</strong>
                                <span>Compras +$50,000</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <strong>100% Seguro</strong>
                                <span>Compra protegida</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hero-image">
                    <img th:src="@{/img/hero-products.jpg}" alt="Productos frescos" onerror="this.style.display='none'">
                </div>
            </div>
        </div>
    </section>

    <div class="container main-layout">
        <!-- SIDEBAR DE NAVEGACI√ìN (Estilo Amazon/MercadoLibre) -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3><i class="fas fa-bars"></i> Categor√≠as</h3>
                <ul class="category-list">
                    <li>
                        <a th:href="@{/publico/productos}" th:classappend="${categoriaId == null} ? 'active' : ''">
                            <i class="fas fa-th"></i>
                            <span>Todas las Categor√≠as</span>
                        </a>
                    </li>
                    <!-- Categor√≠as din√°micas desde la tabla categoria -->
                    <li th:each="cat : ${categorias}">
                        <a th:href="@{/publico/productos(categoriaId=${cat.id})}" 
                           th:classappend="${categoriaId != null && categoriaId == cat.id} ? 'active' : ''">
                            <!-- Mapeo de iconos seg√∫n el nombre de la categor√≠a -->
                            <i th:class="${
                                #strings.containsIgnoreCase(cat.nombre, 'FRUTA') ? 'fas fa-apple-alt' :
                                #strings.containsIgnoreCase(cat.nombre, 'VERDURA') ? 'fas fa-carrot' :
                                #strings.containsIgnoreCase(cat.nombre, 'LACTEO') or #strings.containsIgnoreCase(cat.nombre, 'LECHE') ? 'fas fa-cheese' :
                                #strings.containsIgnoreCase(cat.nombre, 'CARNE') ? 'fas fa-drumstick-bite' :
                                #strings.containsIgnoreCase(cat.nombre, 'BEBIDA') ? 'fas fa-wine-bottle' :
                                #strings.containsIgnoreCase(cat.nombre, 'PAN') or #strings.containsIgnoreCase(cat.nombre, 'PANADERIA') ? 'fas fa-bread-slice' :
                                #strings.containsIgnoreCase(cat.nombre, 'GRANO') or #strings.containsIgnoreCase(cat.nombre, 'CEREAL') ? 'fas fa-seedling' :
                                #strings.containsIgnoreCase(cat.nombre, 'ENLATA') ? 'fas fa-can-food' :
                                #strings.containsIgnoreCase(cat.nombre, 'SNACK') or #strings.containsIgnoreCase(cat.nombre, 'DULCE') ? 'fas fa-cookie-bite' :
                                #strings.containsIgnoreCase(cat.nombre, 'CONGELA') ? 'fas fa-snowflake' :
                                #strings.containsIgnoreCase(cat.nombre, 'ASEO') or #strings.containsIgnoreCase(cat.nombre, 'LIMPIEZA') ? 'fas fa-soap' :
                                #strings.containsIgnoreCase(cat.nombre, 'HIGIENE') or #strings.containsIgnoreCase(cat.nombre, 'CUIDADO') ? 'fas fa-hand-sparkles' :
                                'fas fa-box'
                            }"></i>
                            <!-- Mostrar nombre de la categor√≠a -->
                            <span th:text="${cat.nombre}">Categor√≠a</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-filter"></i> Filtrar por Precio</h3>
                <div class="price-range">
                    <input type="range" id="priceRange" min="0" max="100000" step="1000" value="100000">
                    <div class="price-labels">
                        <span>$0</span>
                        <span id="priceValue">$100,000</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-star"></i> Destacados</h3>
                <ul class="feature-list">
                    <li>
                        <i class="fas fa-fire"></i>
                        <span>M√°s Vendidos</span>
                    </li>
                    <li>
                        <i class="fas fa-tag"></i>
                        <span>Ofertas</span>
                    </li>
                    <li>
                        <i class="fas fa-star"></i>
                        <span>Nuevos</span>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section promo-banner">
                <i class="fas fa-gift"></i>
                <h4>¬°Env√≠o Gratis!</h4>
                <p>En compras mayores a $50,000</p>
            </div>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="main-content-area">
            <!-- Search Bar -->
            <section class="search-section">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input id="searchInput" 
                           type="search" 
                           placeholder="Buscar productos (ej. manzana, leche, carne...)" 
                           th:value="${q}" />
                    <button id="searchBtn" class="btn-search">
                        <i class="fas fa-search"></i>
                        Buscar
                    </button>
                </div>
            </section>

            <!-- Filters -->
            <section class="filters-section">
            <div class="filters-header">
                <h2><i class="fas fa-filter"></i> Filtros y Ordenamiento</h2>
                <button class="btn-clear-filters" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Limpiar filtros
                </button>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label><i class="fas fa-list"></i> Categor√≠a</label>
                    <select id="categoriaFilter" class="filter-select">
                        <option value="">Todas las categor√≠as</option>
                        <option value="FRUTA" th:selected="${categoria == 'FRUTA'}">üçé Frutas</option>
                        <option value="VERDURA" th:selected="${categoria == 'VERDURA'}">ü•¨ Verduras</option>
                        <option value="LACTEO" th:selected="${categoria == 'LACTEO'}">ü•õ L√°cteos</option>
                        <option value="CARNE" th:selected="${categoria == 'CARNE'}">ü•© Carnes</option>
                        <option value="BEBIDA" th:selected="${categoria == 'BEBIDA'}">ü•§ Bebidas</option>
                        <option value="PANADERIA" th:selected="${categoria == 'PANADERIA'}">üçû Panader√≠a</option>
                        <option value="GRANOS" th:selected="${categoria == 'GRANOS'}">üåæ Granos</option>
                        <option value="ENLATADO" th:selected="${categoria == 'ENLATADO'}">ü•´ Enlatados</option>
                        <option value="OTRO" th:selected="${categoria == 'OTRO'}">üì¶ Otros</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-sort"></i> Ordenar por</label>
                    <select id="ordenFilter" class="filter-select">
                        <option value="default" th:selected="${orden == null or orden == 'default'}">M√°s relevantes</option>
                        <option value="precioAsc" th:selected="${orden == 'precioAsc'}">üí∞ Precio: Menor a Mayor</option>
                        <option value="precioDesc" th:selected="${orden == 'precioDesc'}">üíé Precio: Mayor a Menor</option>
                        <option value="nombre" th:selected="${orden == 'nombre'}">üî§ Nombre A-Z</option>
                        <option value="nuevo" th:selected="${orden == 'nuevo'}">‚ú® M√°s nuevos</option>
                    </select>
                </div>

                <div class="view-toggle">
                    <label><i class="fas fa-th"></i> Vista</label>
                    <div class="toggle-buttons">
                        <button class="btn-view active" data-view="grid" title="Vista de cuadr√≠cula">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="btn-view" data-view="list" title="Vista de lista">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Products Grid -->
        <section class="products-section">
            <div class="products-header">
                <h2>
                    <i class="fas fa-shopping-basket"></i> 
                    <span th:if="${q != null and q != ''}" th:text="'Resultados para: ' + ${q}">Todos los Productos</span>
                    <span th:if="${q == null or q == ''}">Todos los Productos</span>
                </h2>
                <span class="product-count" th:if="${productosPage != null}">
                    Mostrando 
                    <strong th:text="${productosPage.numberOfElements}">0</strong> 
                    de 
                    <strong th:text="${productosPage.totalElements}">0</strong> 
                    productos
                </span>
            </div>

            <!-- Empty State -->
            <div th:if="${productosPage == null or #lists.isEmpty(productosPage.content)}" class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3>No hay productos disponibles</h3>
                <p>Intenta ajustar los filtros o realiza una b√∫squeda diferente</p>
                <button class="btn-primary" onclick="clearFilters()">Ver todos los productos</button>
            </div>

            <!-- Products Grid -->
            <div class="product-grid" id="productGrid" th:if="${productosPage != null and not #lists.isEmpty(productosPage.content)}">
                <div th:each="p : ${productosPage.content}" 
                     class="product-card card-producto"
                     th:attr="data-nombre=${p.nombre}, data-precio=${p.precioVenta}">
                    <div class="product-badges">
                        <span class="badge badge-new" th:if="${p.estado != null and p.estado == 'ACTIVO'}">Disponible</span>
                    </div>
                    
                    <div class="product-image">
                        <img th:src="@{${p.imagenUrl != null ? p.imagenUrl : '/img/placeholder.png'}}" 
                             th:alt="${p.nombre}"
                             loading="lazy"/>
                        <div class="product-overlay">
                            <button class="btn-icon" title="Vista r√°pida" onclick="quickView(this)" th:attr="data-id=${p.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="product-body">
                        <div class="product-category" th:if="${p.categoria != null}">
                            <i class="fas fa-tag"></i>
                            <span th:text="${p.categoria.nombre}">Categor√≠a</span>
                        </div>
                        <h3 class="product-title" th:text="${p.nombre}">Nombre producto</h3>
                        <p class="product-desc" th:text="${p.descripcion != null ? p.descripcion : 'Producto de calidad'}">Descripci√≥n breve del producto</p>
                        
                        <div class="product-info">
                            <span class="product-brand" th:if="${p.marca != null}">
                                <i class="fas fa-certificate"></i>
                                <span th:text="${p.marca}">Marca</span>
                            </span>
                            <span class="product-sku" th:if="${p.sku != null}">
                                <i class="fas fa-barcode"></i>
                                <span th:text="${p.sku}">SKU</span>
                            </span>
                        </div>
                        
                        <div class="product-footer">
                            <div class="product-price-section">
                                <div class="product-price">
                                    <span class="price-current">
                                        $<span th:text="${#numbers.formatDecimal(p.precioVenta, 0, 'COMMA', 0, 'POINT')}">0</span>
                                    </span>
                                    <span class="price-currency">COP</span>
                                </div>
                                <!-- Badge de disponibilidad seg√∫n stock real -->
                                <div class="stock-badge">
                                    <span th:if="${stockMap[p.id] != null and stockMap[p.id] > 0}" class="badge-stock badge-available">
                                        <i class="fas fa-check-circle"></i> En stock (<span th:text="${stockMap[p.id]}">0</span>)
                                    </span>
                                    <span th:if="${stockMap[p.id] == null or stockMap[p.id] == 0}" class="badge-stock badge-unavailable">
                                        <i class="fas fa-times-circle"></i> Agotado
                                    </span>
                                </div>
                            </div>
                            <button class="btn-add-cart add-to-cart" 
                                    th:attr="data-id=${p.id}"
                                    th:disabled="${stockMap[p.id] == null or stockMap[p.id] == 0}">
                                <i class="fas fa-cart-plus"></i>
                                <span>Agregar</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pagination -->
        <section class="pagination-section" th:if="${productosPage != null and productosPage.totalPages > 1}">
            <div class="pagination-container">
                <!-- Informaci√≥n de paginaci√≥n -->
                <div class="pagination-info">
                    <span>P√°gina <strong th:text="${productosPage.number + 1}">1</strong> de <strong th:text="${productosPage.totalPages}">1</strong></span>
                </div>
                
                <!-- Controles de paginaci√≥n -->
                <div class="pagination">
                    <!-- Primera p√°gina -->
                    <a th:if="${productosPage.number > 0}" 
                       th:href="@{/publico/productos(page=0, q=${q}, categoria=${categoria}, orden=${orden})}" 
                       class="page-btn page-first"
                       title="Primera p√°gina">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    
                    <!-- Anterior -->
                    <a th:if="${productosPage.hasPrevious()}" 
                       th:href="@{/publico/productos(page=${productosPage.number - 1}, q=${q}, categoria=${categoria}, orden=${orden})}" 
                       class="page-btn page-prev"
                       title="P√°gina anterior">
                        <i class="fas fa-chevron-left"></i>
                        <span class="btn-text">Anterior</span>
                    </a>
                    
                    <!-- N√∫meros de p√°gina -->
                    <div class="page-numbers">
                        <!-- L√≥gica: mostrar p√°ginas cercanas a la actual -->
                        <th:block th:each="i : ${#numbers.sequence(0, productosPage.totalPages - 1)}">
                            <!-- Primera p√°gina siempre -->
                            <a th:if="${i == 0}"
                               th:href="@{/publico/productos(page=${i}, q=${q}, categoria=${categoria}, orden=${orden})}"
                               th:text="${i + 1}"
                               class="page-num"
                               th:classappend="${i == productosPage.number} ? 'active' : ''">1</a>
                            
                            <!-- Puntos suspensivos inicio -->
                            <span th:if="${i == 1 and productosPage.number > 3}" class="page-dots">...</span>
                            
                            <!-- P√°ginas cercanas (¬±2 de la actual) -->
                            <a th:if="${i > 0 and i < productosPage.totalPages - 1 and i >= productosPage.number - 2 and i <= productosPage.number + 2}"
                               th:href="@{/publico/productos(page=${i}, q=${q}, categoria=${categoria}, orden=${orden})}"
                               th:text="${i + 1}"
                               class="page-num"
                               th:classappend="${i == productosPage.number} ? 'active' : ''">1</a>
                            
                            <!-- Puntos suspensivos final -->
                            <span th:if="${i == productosPage.totalPages - 2 and productosPage.number < productosPage.totalPages - 4}" class="page-dots">...</span>
                            
                            <!-- √öltima p√°gina siempre -->
                            <a th:if="${i == productosPage.totalPages - 1 and productosPage.totalPages > 1}"
                               th:href="@{/publico/productos(page=${i}, q=${q}, categoria=${categoria}, orden=${orden})}"
                               th:text="${i + 1}"
                               class="page-num"
                               th:classappend="${i == productosPage.number} ? 'active' : ''">1</a>
                        </th:block>
                    </div>
                    
                    <!-- Siguiente -->
                    <a th:if="${productosPage.hasNext()}" 
                       th:href="@{/publico/productos(page=${productosPage.number + 1}, q=${q}, categoria=${categoria}, orden=${orden})}" 
                       class="page-btn page-next"
                       title="P√°gina siguiente">
                        <span class="btn-text">Siguiente</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    
                    <!-- √öltima p√°gina -->
                    <a th:if="${productosPage.number < productosPage.totalPages - 1}" 
                       th:href="@{/publico/productos(page=${productosPage.totalPages - 1}, q=${q}, categoria=${categoria}, orden=${orden})}" 
                       class="page-btn page-last"
                       title="√öltima p√°gina">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </div>
                
                <!-- Ir a p√°gina espec√≠fica -->
                <div class="page-jump">
                    <label for="pageJump">Ir a p√°gina:</label>
                    <input type="number" 
                           id="pageJump" 
                           min="1" 
                           th:max="${productosPage.totalPages}"
                           th:value="${productosPage.number + 1}"
                           class="page-input">
                    <button onclick="jumpToPage()" class="btn-jump">Ir</button>
                </div>
            </div>
        </section>
        </div><!-- Cierre main-content-area -->
    </div><!-- Cierre main-layout -->
</main>

<!-- Toast Notification -->
<div id="toast" class="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">Producto agregado al carrito</span>
</div>

<!-- Quick View Modal -->
<div id="quickViewModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-body">
            <div class="modal-image">
                <img id="modalImage" src="" alt="Producto">
            </div>
            <div class="modal-info">
                <h2 id="modalTitle">Nombre del Producto</h2>
                <div class="modal-rating">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i>
                    <span>(4.5)</span>
                </div>
                <p id="modalDescription">Descripci√≥n del producto</p>
                <div class="modal-price">
                    <span class="price-label">Precio:</span>
                    <span class="price-value" id="modalPrice">$0 COP</span>
                </div>
                <div class="modal-stock">
                    <i class="fas fa-check-circle"></i>
                    <span id="modalStock">En stock</span>
                </div>
                <button class="btn-primary btn-large" id="modalAddCart">
                    <i class="fas fa-cart-plus"></i>
                    Agregar al carrito
                </button>
            </div>
        </div>
    </div>
</div>

<footer class="public-footer">
    <div class="footer-content">
        <div class="footer-section">
            <h3><i class="fas fa-store"></i> Merko</h3>
            <p>Tu tienda de confianza para productos frescos y de calidad</p>
            <div class="footer-social">
                <a href="#" title="Facebook"><i class="fab fa-facebook"></i></a>
                <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
            </div>
        </div>
        <div class="footer-section">
            <h4>Informaci√≥n</h4>
            <ul>
                <li><a href="#"><i class="fas fa-angle-right"></i> Sobre nosotros</a></li>
                <li><a href="#"><i class="fas fa-angle-right"></i> T√©rminos y condiciones</a></li>
                <li><a href="#"><i class="fas fa-angle-right"></i> Pol√≠tica de privacidad</a></li>
                <li><a href="#"><i class="fas fa-angle-right"></i> Preguntas frecuentes</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>Atenci√≥n al cliente</h4>
            <ul>
                <li><a href="#"><i class="fas fa-angle-right"></i> Contacto</a></li>
                <li><a href="#"><i class="fas fa-angle-right"></i> Env√≠os y devoluciones</a></li>
                <li><a href="#"><i class="fas fa-angle-right"></i> M√©todos de pago</a></li>
                <li><a href="#"><i class="fas fa-angle-right"></i> Seguimiento de pedidos</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>Contacto</h4>
            <ul class="footer-contact">
                <li><i class="fas fa-phone"></i> +57 123 456 7890</li>
                <li><i class="fas fa-envelope"></i> info@merko.com</li>
                <li><i class="fas fa-map-marker-alt"></i> Bogot√°, Colombia</li>
                <li><i class="fas fa-clock"></i> Lun - S√°b: 8:00 - 20:00</li>
            </ul>
        </div>
    </div>
    <div class="footer-bottom">
        <p>¬© <span th:text="${T(java.time.Year).now().value}">2025</span> Merko - Todos los derechos reservados</p>
    </div>
</footer>

<script th:src="@{/js/publico/productos.js}"></script>
</body>
</html>
